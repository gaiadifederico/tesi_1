"""
Codice per tdEIT offline da raw data (16 electrodes, 208 measurements)
"""
from __future__ import division, absolute_import, print_function
import logging
import itertools
import time
import threading
import numpy as np
import matplotlib.pyplot as plt
from pyeit import mesh 
from pyeit.eit.utils import eit_scan_lines
import pyeit.eit.protocol as protocol
from pyeit.eit.bp import BP as bp
from pyeit.eit.fem import EITForward

logger = logging.getLogger(__name__)


#def update_reference(self,data):
#    baseline_flag = 1

def eit_reconstruction(data):
    """bp.py in reconstruction
    Reconstruct an image from the measurements given by `data`.
    """
    # setup EIT scan conditions
    img = []
    baseline_flag = 1
    n_el = 8 # number of electrodes. 
    step = 1 
    el_dist = int(n_el/2) # random initialize number 

    # we create this according to an opposition protocol to maximize contrast. 
    ex_mat = eit_scan_lines(n_el =n_el, dist =el_dist)
    """ 0. construct mesh """
    # h0 is initial mesh size. , h0=0.1
    mesh_obj, el_pos = mesh.create(n_el)
    """ 3. Set Up BP """
    eit =  bp(mesh_obj,el_pos, ex_mat=ex_mat, step=step, parser='std')

    eit.setup(weight='none')

    try: 
        if baseline_flag == 1:
            f0 = np.array(data)
            baseline_flag = 0 
        # data contains fl.v and f0.v 
        f1 = np.array(data)
        # if the jacobian is not normalized, data may not to be normalized too.
        ds_bp = eit.solve(f1, f0, normalize=True)
        img = np.real(ds_bp)

    except RuntimeError as err:
        logger.error('reconstruction problem: %s', err)

    return img

def parse_line(line):
    try:
        _, data = line.split(";", 1)
    except ValueError:
        return None
    items = []
    for item in data.split(";"):
        item = item.strip()
        if not item:
            continue
        try:
            items.append(float(item))
        except ValueError:
            return None
    return np.array(items)

n_el = 8
""" Load Data: select a file you have created by simdata.py, or recorded through the dashboard """
text_file = open("data.csv", "r")
lines       = text_file.readlines()
print ("length lines: ",len(lines))
# This is the baseline image.
#f0= parse_line(lines[0])
# this is the new difference image. 
#f1= parse_line(lines[1])

#10000 ohm calibration
#f0 = np.array([10469.00,10469.00,10469.00,10469.00,10469.00,10469.00,10469.00,10469.00,10469.00,10000.00,10469.00,10469.00,9686.88,10867.54,9686.88,10469.00,10469.00,10469.00,10469.00,9686.88,10000.00,10469.00,10469.00,10000.00,10000.00,10000.00,10867.54,10000.00,10000.00,10000.00,9686.88,9686.88,9686.88,9686.88,9686.88,9686.88,10867.54,10000.00,9686.88,10867.54])
#f1 = np.array([9003.62,10469.00,10000.00,10469.00,10000.00,11368.61,10000.00,9686.88,9253.38,10469.00,10469.00,9686.88,9686.88,10000.00,9003.62,10000.00,9003.62,10867.54,10867.54,10469.00,9686.88,10867.54,10867.54,9686.88,10000.00,10000.00,10469.00,10469.00,10469.00,10469.00,10867.54,9686.88,9686.88,10469.00,10469.00,9686.88,10867.54,10867.54,9686.88,10867.54])
#f2 = np.array([10000.00,9253.38,10867.54,10469.00,10469.00,9686.88,10867.54,10469.00,9686.88,10000.00,9686.88,10469.00,9253.38,10000.00,10000.00,9686.88,9686.88,9003.62,10000.00,9686.88,9686.88,9686.88,10000.00,10000.00,9686.88,9686.88,10469.00,9686.88,9686.88,10000.00,10867.54,10000.00,10469.00,9003.62,10867.54,10469.00,10000.00,10000.00,10867.54,8724.17])
#f3 = np.array([10469.00,10867.54,10469.00,9686.88,9686.88,10469.00,9686.88,10000.00,10000.00,9253.38,9253.38,10469.00,9686.88,10867.54,10469.00,10000.00,9686.88,9253.38,9686.88,9686.88,9341.37,10867.54,10867.54,9686.88,10000.00,9686.88,10867.54,10469.00,10000.00,9686.88,9003.62,9686.88,9686.88,10469.00,9003.62,9686.88,10000.00,10469.00,9686.88,10000.00])
#f4 = np.array([10000.00,9686.88,10000.00,10000.00,10469.00,9253.38,9686.88,9686.88,9686.88,10000.00,10000.00,9686.88,10000.00,10000.00,10000.00,9686.88,9686.88,10000.00,9686.88,10867.54,10000.00,9686.88,10867.54,9686.88,9253.38,10000.00,10867.54,10000.00,9686.88,9253.38,10469.00,9686.88,10000.00,9686.88,9686.88,10000.00,10000.00,10469.00,10000.00,10000.00])

#f1 = np.array([9253.38,10867.54,10867.54,10867.54,10867.54,10867.54,11368.61,10000.00,10867.54,10867.54,10000.00,10000.00,9686.88,10867.54,10867.54,9686.88,9686.88,10000.00,9686.88,10000.00,10000.00,10000.00,10469.00,10000.00,10469.00,10469.00,10469.00,9686.88,10867.54,9686.88,10867.54,9253.38,9686.88,10469.00,10000.00,10000.00,10867.54,10469.00,10000.00,10469.00])
#f2 = np.array([10469.00,10000.00,10867.54,10000.00,10000.00,10867.54,10469.00,10000.00,10867.54,10469.00,10000.00,9686.88,9686.88,9686.88,10867.54,10867.54,10867.54,10000.00,10000.00,10000.00,10867.54,10469.00,10469.00,10867.54,10000.00,10000.00,9686.88,9686.88,10469.00,9686.88,10469.00,10469.00,10469.00,10000.00,10867.54,10469.00,10469.00,10469.00,9341.37,10867.54])
#f3 = np.array([10000.00,10469.00,10469.00,10000.00,10469.00,9686.88,10469.00,10000.00,10867.54,10469.00,10469.00,10469.00,10469.00,9686.88,10265.70,10000.00,10000.00,9003.62,10867.54,9686.88,9341.37,9686.88,10867.54,10000.00,10867.54,10469.00,10469.00,11884.32,10469.00,9686.88,10867.54,9686.88,10000.00,10000.00,10000.00,10867.54,10469.00,9686.88,10000.00,9686.88])
#f4 = np.array([10469.00,10867.54,10000.00,10469.00,10867.54,9686.88,9686.88,10000.00,10867.54,10469.00,10867.54,10000.00,10867.54,10000.00,10469.00,9686.88,9686.88,10867.54,10867.54,10000.00,10000.00,10000.00,10000.00,10867.54,10469.00,9686.88,10867.54,10469.00,10000.00,10000.00,10867.54,10469.00,10000.00,10000.00,9686.88,10867.54,10867.54,10867.54,10469.00,10469.00])

#f1 = np.array([11368.61,10469.00,10867.54,10469.00,10000.00,10000.00,10867.54,10867.54,10000.00,10867.54,10469.00,9686.88,9686.88,10867.54,10000.00,9686.88,9686.88,10469.00,10469.00,10867.54,9686.88,10469.00,10867.54,10867.54,10867.54,10000.00,10469.00,10469.00,9686.88,9686.88,10867.54,10469.00,9686.88,9686.88,9686.88,10469.00,10000.00,10469.00,10867.54,10000.00])
#f2 = np.array([10867.54,10867.54,10867.54,10867.54,10867.54,10867.54,10867.54,10469.00,10000.00,10000.00,10867.54,10469.00,9686.88,10469.00,10867.54,10469.00,10469.00,10000.00,10867.54,10000.00,10469.00,10867.54,10867.54,9686.88,10867.54,10000.00,10867.54,10469.00,10867.54,10000.00,10000.00,10000.00,10000.00,10469.00,10469.00,10000.00,10000.00,9686.88,10469.00,10867.54])
#f3 = np.array([10000.00,10469.00,10867.54,9686.88,10000.00,10469.00,10000.00,10867.54,10000.00,10000.00,9686.88,10867.54,9686.88,10469.00,10000.00,10000.00,10000.00,10469.00,10000.00,10867.54,9253.38,10469.00,10469.00,9686.88,10265.70,9686.88,9686.88,10469.00,10000.00,9686.88,10469.00,9686.88,10867.54,10000.00,10469.00,10000.00,10469.00,10867.54,10867.54,10469.00])
#f4 = np.array([10867.54,10867.54,10469.00,10867.54,10000.00,10000.00,11884.32,10867.54,9686.88,10000.00,10867.54,9686.88,9686.88,10469.00,10469.00,10469.00,10000.00,9686.88,10469.00,9686.88,10000.00,10000.00,10000.00,10469.00,10000.00,10000.00,9686.88,10000.00,9686.88,9686.88,10469.00,10000.00,10469.00,9686.88,10000.00,10867.54,9686.88,10469.00,10469.00,9686.88])

#f1 = np.array([10000.00,10867.54,10000.00,9686.88,10469.00,10867.54,10469.00,10469.00,10867.54,10867.54,10469.00,10000.00,10000.00,9686.88,10469.00,10000.00,9686.88,10000.00,10867.54,10867.54,9253.38,10000.00,10000.00,10469.00,9686.88,10469.00,10469.00,10469.00,9686.88,9253.38,9686.88,10000.00,9686.88,9686.88,9686.88,10469.00,10867.54,10867.54,10867.54,10867.54])
#f2 = np.array([10469.00,10469.00,10867.54,9686.88,10000.00,10000.00,10000.00,10469.00,9686.88,9686.88,10000.00,10000.00,10867.54,10000.00,10867.54,10867.54,9686.88,10000.00,10867.54,10000.00,10000.00,10000.00,10867.54,9686.88,10469.00,9686.88,10000.00,9686.88,10469.00,9686.88,10867.54,10000.00,10867.54,9686.88,10469.00,10000.00,10000.00,10000.00,10867.54,9686.88])
#f3 = np.array([10469.00,10867.54,11368.61,10469.00,10469.00,10867.54,10000.00,10469.00,10469.00,10469.00,9253.38,9253.38,10000.00,10469.00,11884.32,10469.00,10469.00,10000.00,10469.00,10469.00,9686.88,10000.00,10867.54,9253.38,10469.00,10000.00,10867.54,10469.00,10469.00,10867.54,10867.54,10469.00,10000.00,9686.88,9686.88,10000.00,9253.38,10000.00,9686.88,10867.54])
#f4 = np.array([10867.54,10867.54,10867.54,10867.54,9686.88,9686.88,9686.88,10469.00,10000.00,10469.00,10000.00,10000.00,10867.54,10867.54,10469.00,9686.88,10000.00,9686.88,10469.00,10469.00,10000.00,9686.88,10000.00,10867.54,10000.00,10000.00,10469.00,10469.00,9686.88,9253.38,10867.54,10469.00,9686.88,9686.88,10469.00,10469.00,9686.88,10000.00,9686.88,9686.88])

#500 ohm calibration
#f0=np.array([500.00,481.92,466.96,450.96,480.50,500.00,466.96,480.50,466.96,450.96,500.00,450.96,480.50,500.00,537.22,466.96,466.96,450.96,500.00,424.32,480.50,450.96,466.96,424.32,466.96,500.00,466.96,466.96,450.96,500.00,500.00,437.57,500.00,500.00,466.96,424.32,466.96,500.00,450.96,537.22])
#f1=np.array([450.96,450.96,537.22,500.00,500.00,424.32,466.96,437.57,450.96,450.96,450.96,466.96,537.22,481.92,466.96,500.00,466.96,466.96,466.96,437.57,500.00,500.00,518.49,450.96,480.50,500.00,450.96,466.96,480.50,500.00,537.22,500.00,500.00,466.96,500.00,450.96,480.50,480.50,500.00,480.50])
#f2=np.array([500.00,480.50,466.96,424.32,466.96,466.96,450.96,424.32,450.96,400.25,424.32,434.40,437.57,424.32,500.00,424.32,466.96,424.32,466.96,424.32,466.96,400.25,466.96,400.25,424.32,466.96,500.00,424.32,424.32,466.96,437.57,437.57,466.96,500.00,500.00,411.32,400.25,437.57,450.96,424.32])
#f3=np.array([466.96,450.96,437.57,424.32,481.92,466.96,466.96,400.25,500.00,450.96,437.57,450.96,437.57,437.57,500.00,424.32,450.96,450.96,513.25,410.43,450.96,450.96,500.00,387.79,424.32,450.96,437.57,400.25,424.32,450.96,450.96,437.57,466.96,466.96,466.96,450.96,466.96,424.32,518.49,400.25])
#f4=np.array([450.96,480.50,466.96,466.96,437.57,400.25,437.57,400.25,450.96,424.32,466.96,450.96,500.00,400.25,560.36,450.96,500.00,424.32,500.00,437.57,450.96,437.57,500.00,400.25,437.57,450.96,424.32,424.32,480.50,480.50,424.32,424.32,450.96,466.96,513.25,424.32,424.32,437.57,450.96,424.32])

#f0=np.array([500.00,434.40,500.00,450.96,424.32,424.32,424.32,424.32,437.57,410.43,450.96,424.32,480.50,424.32,466.96,424.32,480.50,424.32,466.96,400.25,450.96,424.32,466.96,400.25,437.57,450.96,424.32,378.48,400.25,411.32,466.96,400.25,400.25,500.00,437.57,424.32,424.32,424.32,450.96,424.32])
#f1=np.array([518.49,518.49,500.00,466.96,560.36,518.49,500.00,466.96,500.00,518.49,466.96,466.96,518.49,518.49,500.00,500.00,450.96,500.00,518.49,466.96,500.00,537.22,518.49,500.00,466.96,500.00,518.49,466.96,518.49,560.36,480.50,500.00,518.49,537.22,500.00,518.49,537.22,500.00,560.36,500.00])
#f2=np.array([537.22,537.22,500.00,481.92,500.00,537.22,537.22,518.49,500.00,500.00,500.00,560.36,500.00,500.00,500.00,513.25,481.92,500.00,537.22,518.49,500.00,537.22,518.49,500.00,500.00,537.22,518.49,500.00,518.49,518.49,500.00,518.49,466.96,500.00,500.00,481.92,500.00,500.00,500.00,500.00])
#f3=np.array([518.49,518.49,560.36,560.36,500.00,560.36,500.00,518.49,500.00,560.36,537.22,518.49,518.49,500.00,500.00,537.22,466.96,518.49,518.49,500.00,500.00,537.22,500.00,500.00,500.00,518.49,500.00,518.49,537.22,466.96,500.00,537.22,560.36,500.00,500.00,518.49,500.00,518.49,560.36,500.00])
#f4=np.array([500.00,560.36,481.92,500.00,500.00,560.36,537.22,537.22,560.36,537.22,481.92,560.36,518.49,518.49,560.36,518.49,537.22,500.00,518.49,466.96,500.00,500.00,537.22,560.36,500.00,500.00,518.49,537.22,560.36,500.00,500.00,560.36,500.00,518.49,500.00,500.00,537.22,500.00,500.00,537.22])

#10k calibration --> first time obtaining values different than calibration....
#f0=np.array([18998.60,21101.08,20440.36,18408.94,20440.36,20440.36,20440.36,19711.29,20440.36,20440.36,18998.60,18998.60,18998.60,18408.94,18998.60,19711.29,18998.60,19711.29,20440.36,20440.36,17732.26,20440.36,18998.60,20440.36,20440.36,18408.94,20440.36,18998.60,18998.60,18998.60,20440.36,18998.60,19711.29,18408.94,18408.94,22090.72,20440.36,19711.29,20440.36,18408.94])
#f1=np.array([20440.36,19711.29,20440.36,18998.60,21101.08,18408.94,18408.94,18408.94,20440.36,20440.36,18998.60,19711.29,18408.94,18408.94,22090.72,20440.36,19711.29,20440.36,18998.60,20440.36,18998.60,20440.36,21101.08,20440.36,20440.36,20440.36,22090.72,20440.36,19525.62,18998.60,21101.08,20440.36,20440.36,19711.29,19711.29,20440.36,20440.36,20440.36,20440.36,18408.94])
#f2=np.array([20440.36,19525.62,20440.36,18998.60,18998.60,18998.60,20440.36,20440.36,18998.60,20440.36,20440.36,18408.94,18408.94,19525.62,21101.08,19711.29,18998.60,19711.29,19525.62,18408.94,20440.36,19711.29,20440.36,18998.60,20440.36,19711.29,19711.29,20440.36,20440.36,18998.60,20440.36,19711.29,20440.36,18998.60,19711.29,18998.60,19711.29,18408.94,18998.60,19525.62])
#f3=np.array([18998.60,20440.36,20440.36,22090.72,18998.60,18998.60,18998.60,20440.36,19711.29,19711.29,20440.36,18998.60,19711.29,20440.36,20440.36,20440.36,20440.36,18998.60,20440.36,18408.94,19711.29,18998.60,22090.72,18998.60,20440.36,19711.29,21101.08,20440.36,20440.36,20440.36,19525.62,19711.29,18408.94,18408.94,19711.29,21178.51,20440.36,20440.36,18998.60,20440.36])
#f4=np.array([22090.72,20440.36,20440.36,19711.29,19711.29,19711.29,18408.94,20440.36,19711.29,20440.36,20440.36,18998.60,20440.36,20440.36,20440.36,18998.60,18408.94,19711.29,20440.36,20440.36,19711.29,18998.60,21101.08,20440.36,20440.36,20440.36,20440.36,20440.36,20440.36,20440.36,22090.72,18408.94,20440.36,18408.94,18408.94,18998.60,21101.08,20440.36,18998.60,18408.94])


#f0=np.array([8913.59,8027.73,9201.71,8595.66,8284.87,8027.73,8913.59,8595.66,8027.73,8595.66,8913.59,8595.66,7522.32,8284.87,8284.87,8027.73,8595.66,8027.73,8027.73,8595.66,7732.65,8913.59,8595.66,8913.59,8913.59,8595.66,8913.59,8595.66,8027.73,8027.73,8595.66,8027.73,8284.87,8913.59,7732.65,8284.87,8284.87,7522.32,8514.69,8027.73])
#f1=np.array([8595.66,8284.87,8913.59,8595.66,8913.59,8027.73,8027.73,8913.59,8913.59,8913.59,8595.66,8514.69,8595.66,8913.59,8913.59,8514.69,8595.66,8595.66,8595.66,8913.59,7732.65,8913.59,8913.59,8595.66,8595.66,8027.73,8284.87,8284.87,8027.73,9633.28,8913.59,8027.73,8284.87,8595.66,8027.73,8595.66,8913.59,8284.87,9201.71,8595.66])
#f2=np.array([8913.59,8913.59,9235.48,8027.73,8595.66,8595.66,8595.66,8284.87,8027.73,8027.73,8913.59,8913.59,8595.66,8595.66,8913.59,8027.73,7732.65,8027.73,8595.66,7522.32,7522.32,7522.32,8913.59,8027.73,7522.32,8284.87,8913.59,7522.32,7522.32,7071.07,8284.87,8027.73,8595.66,7522.32,8027.73,8595.66,8284.87,8027.73,8595.66,7522.32])
#f3=np.array([8913.59,8027.73,9201.71,8027.73,8913.59,8027.73,8913.59,8027.73,8027.73,8595.66,7522.32,8027.73,8595.66,8595.66,8284.87,7522.32,8027.73,8595.66,7732.65,7522.32,8284.87,7522.32,8027.73,7294.59,8027.73,7522.32,8284.87,7071.07,7071.07,8027.73,8913.59,8595.66,7522.32,7732.65,7732.65,7522.32,6880.91,7752.65,7522.32,7752.65])
#f4=np.array([8027.73,8284.87,8913.59,9235.48,8027.73,8913.59,7522.32,8595.66,7522.32,8913.59,8027.73,8027.73,8027.73,8284.87,8913.59,8284.87,8595.66,8027.73,8595.66,8027.73,7732.65,8284.87,8913.59,8027.73,8284.87,8595.66,8913.59,7071.07,7522.32,8027.73,8913.59,8595.66,8027.73,8284.87,8027.73,8027.73,8595.66,7522.32,8913.59,7522.32])

#evidenziatore adjacent
#f0=np.array([10686.50,10982.94,11087.38,12425.78,11869.12,10354.82,11497.47,11087.38,10354.82,11497.47,11497.47,10354.82,10686.50,12425.78,11087.38,11087.38,10686.50,11497.47,11497.47,11497.47,11087.38,11869.12,11497.47,12425.78,11497.47,11497.47,11912.67,11497.47,11497.47,11087.38,10354.82,11087.38,10686.50,10686.50,10686.50,11497.47,11497.47,11087.38,10354.82,11087.38])
#f1=np.array([12425.78,11497.47,11497.47,10686.50,11087.38,11497.47,11087.38,11497.47,11497.47,11087.38,11087.38,11497.47,10982.94,11497.47,11869.12,10686.50,11497.47,11497.47,10982.94,10686.50,10354.82,10686.50,12425.78,10354.82,11497.47,11087.38,11869.12,10686.50,11087.38,10354.82,11869.12,11497.47,11087.38,10686.50,11497.47,10686.50,11497.47,11087.38,12425.78,12425.78])
#f2=np.array([11087.38,11087.38,11497.47,10686.50,10686.50,11087.38,11497.47,11497.47,11497.47,11497.47,11869.12,11497.47,10354.82,11497.47,11869.12,11497.47,10354.82,11087.38,11497.47,11087.38,10686.50,11869.12,11497.47,11497.47,11869.12,11497.47,11497.47,10686.50,10354.82,10686.50,10686.50,11497.47,9974.19,11087.38,10686.50,11497.47,10982.94,11912.67,11497.47,11087.38])
#f3=np.array([12425.78,10686.50,10686.50,10686.50,10686.50,11497.47,10686.50,11087.38,12425.78,10354.82,11087.38,10686.50,11087.38,11497.47,12898.81,11497.47,10686.50,11497.47,10686.50,11497.47,11497.47,11497.47,12425.78,11497.47,11497.47,11087.38,11497.47,10686.50,11497.47,10686.50,11497.47,10686.50,11869.12,10354.82,10982.94,11497.47,11087.38,11087.38,10686.50,11869.12])
#f4=np.array([10686.50,11087.38,11497.47,10354.82,11497.47,11087.38,12425.78,11497.47,11087.38,11497.47,11497.47,10354.82,11087.38,11497.47,11497.47,11497.47,10354.82,11497.47,11497.47,10686.50,11087.38,11087.38,12425.78,11497.47,10686.50,11087.38,11497.47,11087.38,10982.94,11497.47,12425.78,11087.38,11087.38,11087.38,11497.47,10686.50,11497.47,11497.47,11087.38,11497.47])

#evidenziatore opposite
#f0=np.array([11497.47,11497.47,11497.47,11497.47,11497.47,10686.50,11087.38,11497.47,11497.47,11497.47,11497.47,11497.47,10354.82,11087.38,10686.50,10354.82,11497.47,10686.50,12425.78,12425.78,10686.50,11087.38,12425.78,12898.81,10686.50,11497.47,11497.47,11087.38,11087.38,10354.82,9702.90,10354.82])
#f1=np.array([11497.47,12425.78,11497.47,11497.47,11869.12,10686.50,11497.47,11087.38,11497.47,11497.47,11087.38,10686.50,11087.38,11087.38,11497.47,11497.47,11497.47,11497.47,11497.47,11869.12,10354.82,11087.38,11497.47,11497.47,11497.47,11869.12,10686.50,10354.82,11087.38,11497.47,10354.82,9974.19])
#f2=np.array([10982.94,11497.47,11497.47,11869.12,10686.50,11497.47,11497.47,11869.12,10686.50,11497.47,12425.78,11087.38,11497.47,10686.50,11087.38,11912.67,11497.47,11497.47,11497.47,11497.47,11087.38,11497.47,11497.47,11087.38,11497.47,11497.47,11497.47,11912.67,11497.47,10686.50,10354.82,10354.82])
#f3=np.array([11497.47,11497.47,11497.47,11497.47,10686.50,10354.82,11497.47,11497.47,11869.12,11869.12,12425.78,12425.78,10686.50,10686.50,10354.82,10354.82,11497.47,11497.47,11497.47,11087.38,10354.82,11087.38,11497.47,11087.38,11869.12,11497.47,10686.50,12425.78,11497.47,10686.50,10686.50,10354.82])
#f4=np.array([12425.78,11497.47,11087.38,11497.47,11497.47,11087.38,10686.50,11497.47,11912.67,12425.78,12425.78,10686.50,12425.78,10686.50,11497.47,10686.50,11497.47,11912.67,11497.47,10686.50,10354.82,12843.57,11497.47,11087.38,11497.47,12425.78,10686.50,10354.82,11497.47,10686.50,11497.47,9974.19])

#pennarello opposite
#f0=np.array([11869.12,12425.78,11497.47,11497.47,10686.50,11497.47,10686.50,11497.47,10686.50,11087.38,11497.47,11497.47,11497.47,11087.38,11869.12,11497.47,11497.47,11869.12,11497.47,11497.47,11087.38,11497.47,11087.38,10686.50,12425.78,11497.47,12425.78,11087.38,11497.47,11497.47,10686.50,9702.90])
#f1=np.array([11497.47,11497.47,10686.50,11869.12,10982.94,11497.47,10686.50,11497.47,10686.50,11869.12,12425.78,11497.47,11087.38,10354.82,11087.38,11087.38,10686.50,12898.81,11497.47,11497.47,11497.47,11087.38,10354.82,10686.50,11497.47,12425.78,11087.38,11497.47,10686.50,10982.94,10686.50,10354.82])
#f2=np.array([11497.47,11497.47,11497.47,12425.78,11497.47,11497.47,11497.47,11497.47,11497.47,10686.50,12898.81,11087.38,11869.12,10354.82,11869.12,11497.47,11497.47,10982.94,11497.47,11497.47,10982.94,10354.82,11497.47,11497.47,10982.94,12425.78,11087.38,11087.38,10354.82,10686.50,10686.50,10354.82])
#f3=np.array([10982.94,12425.78,10686.50,11087.38,11497.47,10686.50,11087.38,12425.78,10686.50,10982.94,11869.12,12425.78,11087.38,10686.50,11497.47,11497.47,10686.50,11087.38,11869.12,11497.47,10354.82,11497.47,10686.50,11087.38,11497.47,11869.12,12425.78,11497.47,11497.47,10686.50,11087.38,10354.82])
#f4=np.array([11912.67,11869.12,10982.94,11497.47,10686.50,11869.12,11869.12,11869.12,11912.67,10686.50,12425.78,11497.47,11087.38,10000.00,11497.47,11087.38,10686.50,11087.38,11497.47,11869.12,11912.67,11087.38,11497.47,11497.47,11497.47,12425.78,11087.38,11497.47,10354.82,11497.47,10354.82,10354.82])

#evidenziatore adj
f0=np.array([11869.12,11497.47,11497.47,11087.38,11087.38,11087.38,11087.38,11087.38,11497.47,11497.47,11497.47,10354.82,11497.47,10982.94,11497.47,11087.38,11497.47,11497.47,11497.47,11087.38,11497.47,11497.47,12425.78,11087.38,10686.50,11087.38,11497.47,10686.50,10686.50,11497.47,10686.50,11497.47,11087.38,10354.82,11497.47,11497.47,11497.47,11497.47,11497.47,11087.38])
#f1=np.array([11497.47,11087.38,11869.12,11497.47,11497.47,11497.47,11497.47,11497.47,10686.50,11497.47,11087.38,11912.67,11087.38,11087.38,10686.50,11497.47,11497.47,10686.50,11087.38,11869.12,10354.82,11497.47,11497.47,10686.50,11497.47,10354.82,11497.47,11497.47,11497.47,11087.38,11497.47,11087.38,11497.47,10686.50,11497.47,11497.47,11497.47,10686.50,10354.82,10686.50])
#f2=np.array([11497.47,11087.38,11497.47,11087.38,11087.38,11497.47,11912.67,11087.38,11497.47,10686.50,11497.47,11087.38,9974.19,11497.47,11497.47,11087.38,11087.38,10686.50,12425.78,11497.47,11869.12,11497.47,11497.47,11497.47,11497.47,10686.50,10686.50,11087.38,10686.50,10686.50,10354.82,11497.47,11087.38,10354.82,10686.50,11497.47,10686.50,11087.38,11497.47,11497.47])
#f3=np.array([12425.78,12425.78,11497.47,10354.82,11497.47,10686.50,11497.47,11087.38,12425.78,11497.47,11497.47,11087.38,11497.47,11869.12,12425.78,10686.50,11497.47,11497.47,11497.47,11497.47,10686.50,11087.38,11497.47,11497.47,10686.50,11869.12,12898.81,11912.67,10354.82,11497.47,11497.47,11497.47,11497.47,10354.82,10686.50,11497.47,11497.47,11497.47,11497.47,10686.50])
#f4=np.array([11869.12,12425.78,10686.50,11497.47,11497.47,10686.50,11497.47,11497.47,11497.47,11497.47,11497.47,10686.50,10686.50,11497.47,11497.47,10686.50,11497.47,11497.47,11497.47,11497.47,11497.47,11087.38,11869.12,11497.47,10686.50,11087.38,11497.47,11087.38,11497.47,11087.38,11497.47,11497.47,11497.47,11497.47,9974.19,11087.38,11497.47,11087.38,11497.47,10686.50])

#evidenziatore+pennarello
#f1=np.array([11869.12,11497.47,11497.47,11497.47,11497.47,11497.47,11497.47,11497.47,11497.47,11497.47,11497.47,11497.47,10686.50,11497.47,11497.47,11087.38,11497.47,10686.50,11497.47,11087.38,11912.67,11869.12,11869.12,11497.47,11497.47,11869.12,12425.78,11497.47,10686.50,11497.47,10686.50,11497.47,10686.50,12425.78,10354.82,10686.50,11087.38,11497.47,11087.38,11087.38])
#f2=np.array([11497.47,11869.12,12425.78,11087.38,12425.78,12425.78,11497.47,10354.82,11497.47,11497.47,12425.78,10686.50,11497.47,11497.47,11087.38,11497.47,11497.47,11497.47,12425.78,11497.47,12425.78,12425.78,11497.47,11087.38,11497.47,10686.50,12425.78,11869.12,11497.47,11497.47,11497.47,11087.38,10686.50,10354.82,10354.82,10686.50,11497.47,11497.47,11497.47,11087.38])
#f3=np.array([11869.12,12425.78,12425.78,11497.47,11087.38,11087.38,10982.94,11497.47,11087.38,11497.47,10982.94,11869.12,11497.47,11497.47,11497.47,11087.38,11497.47,11497.47,11497.47,11497.47,11497.47,11869.12,10686.50,11912.67,11497.47,12425.78,11497.47,11497.47,11912.67,11497.47,11497.47,11497.47,10686.50,11497.47,12425.78,11087.38,11087.38,12425.78,12425.78,11912.67])
#f4=np.array([12425.78,11497.47,11869.12,11497.47,12425.78,11497.47,11087.38,12425.78,10686.50,12425.78,11497.47,11497.47,11497.47,11087.38,11497.47,11497.47,11087.38,10686.50,12425.78,11497.47,10982.94,11497.47,10982.94,11869.12,11869.12,11497.47,11497.47,11087.38,12425.78,11497.47,12425.78,11497.47,11497.47,11497.47,11497.47,11497.47,11912.67,10686.50,10982.94,11497.47])

#pennarello adj
#f1=np.array([11497.47,11087.38,12425.78,11497.47,11087.38,10354.82,12425.78,11497.47,11497.47,12425.78,12425.78,11497.47,11497.47,10354.82,11497.47,10354.82,10354.82,11497.47,10686.50,10982.94,11497.47,10686.50,11497.47,11869.12,12425.78,10686.50,11497.47,11497.47,11497.47,11497.47,11869.12,10686.50,10686.50,11087.38,10686.50,10686.50,10686.50,10686.50,11497.47,11869.12])
#f2=np.array([12898.81,11869.12,11497.47,10686.50,11497.47,12425.78,11497.47,11497.47,11087.38,11497.47,11497.47,11497.47,11497.47,11497.47,12425.78,11497.47,10686.50,11497.47,11869.12,11087.38,12425.78,12425.78,12425.78,12425.78,11497.47,11497.47,11497.47,11497.47,11497.47,11497.47,11497.47,10982.94,10982.94,10686.50,11087.38,10982.94,11087.38,12425.78,11497.47,11497.47])
#f3=np.array([12425.78,11087.38,11497.47,11497.47,12425.78,11497.47,11497.47,10354.82,10354.82,11869.12,11087.38,11912.67,11087.38,11497.47,11497.47,11497.47,10686.50,11497.47,11497.47,11497.47,11087.38,11087.38,11497.47,11497.47,10982.94,11497.47,11497.47,11497.47,11497.47,11087.38,11497.47,11497.47,11497.47,10686.50,10354.82,11497.47,12425.78,10686.50,11497.47,11497.47])
#f4=np.array([11497.47,10686.50,12425.78,11497.47,11497.47,12425.78,11869.12,11912.67,11497.47,10354.82,11497.47,10686.50,11869.12,11497.47,11087.38,11087.38,11869.12,10354.82,12425.78,10982.94,10686.50,11912.67,11497.47,11497.47,11497.47,11087.38,11497.47,11497.47,11497.47,10354.82,11869.12,11497.47,10686.50,11497.47,11087.38,10982.94,11497.47,11497.47,11869.12,11497.47])


#pennarello opp
f0=np.array([12425.78,11869.12,11869.12,11497.47,11497.47,11869.12,11497.47,11497.47,11087.38,11497.47,11869.12,11869.12,11497.47,10982.94,11497.47,11497.47,10686.50,12425.78,10686.50,10686.50,10686.50,11497.47,10686.50,12425.78,10686.50,12898.81,10686.50,11087.38,11087.38,11087.38,12425.78,11497.47])
f1=np.array([11497.47,11087.38,11497.47,12425.78,12425.78,10686.50,10686.50,11087.38,11869.12,11497.47,11869.12,10686.50,12425.78,11497.47,11497.47,11497.47,11087.38,11087.38,12425.78,10686.50,10686.50,11869.12,10686.50,11497.47,10354.82,11869.12,10686.50,11497.47,11497.47,10686.50,11087.38,11087.38])
f2=np.array([11497.47,11497.47,11497.47,11497.47,11497.47,11497.47,11497.47,11869.12,11087.38,11497.47,12425.78,10982.94,11497.47,9974.19,10686.50,10982.94,11497.47,11497.47,11497.47,11912.67,11497.47,11087.38,10686.50,10686.50,12425.78,11497.47,11087.38,10686.50,11497.47,11497.47,11497.47,11497.47])
f3=np.array([11869.12,11869.12,11912.67,12425.78,10686.50,11912.67,11497.47,12425.78,11912.67,11497.47,12898.81,10686.50,11497.47,10686.50,11087.38,11497.47,11497.47,12425.78,13493.53,11497.47,10686.50,12425.78,11087.38,11497.47,11869.12,11497.47,11087.38,11912.67,11087.38,11912.67,11497.47,11087.38])
f4=np.array([11869.12,11869.12,11497.47,10686.50,11497.47,11497.47,11087.38,12425.78,11497.47,11087.38,12425.78,11497.47,11497.47,10686.50,11912.67,11869.12,11912.67,11497.47,12425.78,11087.38,10354.82,11869.12,10686.50,11912.67,11497.47,12425.78,11912.67,10686.50,11497.47,11497.47,11087.38,10686.50])



data_baseline = f0
print ('f0',len(f0),len(f1),len(f2),len(f3), len(f4))
#g.update_reference(data_baseline)
# set the baseline. 

#baseline = eit_reconstruction(f0)
# do the reconstruction. 
#difference_image = eit_reconstruction(f1)
#print (difference_image)
# #print(g.__dict__)

img = []
baseline_flag = 1
n_el = 8 # number of electrodes. 
step = 1 
el_dist = 4 # random initialize number 

# we create this according to an opposition protocol to maximize contrast. 
ex_mat = eit_scan_lines(n_el =n_el, dist =el_dist)
""" 0. construct mesh """
# h0 is initial mesh size. , h0=0.1
mesh_obj= mesh.create(n_el)
el_pos = mesh_obj.el_pos
protocol_obj = protocol.create(n_el, dist_exc=4, step_meas=1, parser_meas="std")

# Define electrode current sink and current source
#ex_line = protocol_obj.ex_mat[0].ravel()


""" 3. Set Up BP """
#BACKPROJECTION
eit =  bp(mesh_obj, protocol_obj)
#        self.eit =  bp(self.mesh_obj,self.el_pos, ex_mat=self.ex_mat, step=self.step, parser='std')

eit.setup(weight='none')

ds_bp_1 = eit.solve(f1, f0, normalize=True)
difference_image_1= np.real(ds_bp_1)

ds_bp_2 = eit.solve(f2, f0, normalize=True)
difference_image_2= np.real(ds_bp_2)

ds_bp_3 = eit.solve(f3, f0, normalize=True)
difference_image_3= np.real(ds_bp_3)

ds_bp_4 = eit.solve(f4, f0, normalize=True)
difference_image_4= np.real(ds_bp_4)




pts     = mesh_obj.node
tri = mesh_obj.element
x   = pts[:, 0]
y   = pts[:, 1]

#BACKPROJECTION
fig, axes = plt.subplots(1,4)
ax=axes[0]
im_1 = ax.tripcolor(x,y, tri, difference_image_1,
                  shading='flat', cmap=plt.cm.gnuplot)
#fig.colorbar(im_1)
ax.plot(x[el_pos], y[el_pos], 'ro')
for i, e in enumerate(el_pos):
    ax.text(x[e], y[e], str(i+1), size=12)
ax.axis('equal')
ax=axes[1]
im_2 = ax.tripcolor(x,y, tri, difference_image_2,
                  shading='flat', cmap=plt.cm.gnuplot)
#fig.colorbar(im_2)
ax.plot(x[el_pos], y[el_pos], 'ro')
for i, e in enumerate(el_pos):
    ax.text(x[e], y[e], str(i+1), size=12)
ax.axis('equal')
ax=axes[2]
im_3 = ax.tripcolor(x,y, tri, difference_image_3,
                  shading='flat', cmap=plt.cm.gnuplot)
#fig.colorbar(im_3)
ax.plot(x[el_pos], y[el_pos], 'ro')
for i, e in enumerate(el_pos):
    ax.text(x[e], y[e], str(i+1), size=12)
ax.axis('equal')
ax=axes[3]
im_4 = ax.tripcolor(x,y, tri, difference_image_4,
                  shading='flat', cmap=plt.cm.gnuplot)
ax.plot(x[el_pos], y[el_pos], 'ro')
#fig.colorbar(im_4)
for i, e in enumerate(el_pos):
    ax.text(x[e], y[e], str(i+1), size=12)
ax.axis('equal')
plt.show()




